<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>닐리의 전략 아카이브 — OCR 버전</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { color-scheme: light dark; --bg:#fff; --fg:#0a0a0a; --muted:#6b7280; --card:#fff; --line:#e5e7eb; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0b0c; --fg:#f5f5f5; --muted:#cbd5e1; --card:#111113; --line:#30363d; }
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:940px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    @media (prefers-color-scheme: dark){ header{background:rgba(17,17,17,.9)} }
    h1{margin:0;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button,textarea,select{font:inherit}
    input[type=text], textarea{flex:1;min-width:160px;border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:10px;padding:8px 10px}
    textarea{min-height:120px;resize:vertical}
    button{border:1px solid var(--line);background:var(--card);color:var(--fg);border-radius:10px;padding:8px 12px;cursor:pointer}
    button.primary{background:#111827;color:#fff;border-color:#111827}
    button.danger{color:#b91c1c;border-color:#b91c1c}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
    .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .empty{border:1px dashed var(--line);text-align:center;padding:24px;border-radius:14px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .thumb{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    progress{width:180px;height:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="padding:10px 16px">
      <h1>닐리의 전략 아카이브</h1>
      <span class="muted">OCR beta</span>
      <div class="right toolbar">
        <button id="btnExport">내보내기(JSON)</button>
        <input id="fileIn" type="file" accept="application/json" style="display:none" />
        <button id="btnImport">가져오기</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:12px">
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="margin-bottom:8px">
        <input id="title" type="text" placeholder="제목 (예: 책/페이지/메모)" />
        <input id="tags" type="text" placeholder="태그(쉼표)" style="flex:0 1 260px" />
      </div>
      <div class="row" style="align-items:flex-start;gap:12px">
        <div class="pill">
          <input id="imgIn" type="file" accept="image/*" multiple />
          <span class="muted">이미지 선택 (여러 장 가능)</span>
        </div>
        <button id="btnOCR" class="primary">사진에서 텍스트 추출 → 추가</button>
        <div class="row">
          <label class="muted">언어</label>
          <select id="lang">
            <option value="eng+kor">영어+한국어</option>
            <option value="kor">한국어</option>
            <option value="eng">영어</option>
          </select>
        </div>
        <div id="ocrStatus" class="muted"></div>
      </div>
      <div id="thumbs" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
      <textarea id="note" placeholder="(선택) 메모/정리 텍스트"></textarea>
    </div>

    <div class="row" style="margin-bottom:10px">
      <input id="q" type="text" placeholder="검색: 제목/태그/내용" />
    </div>

    <div id="stats" class="muted" style="margin:8px 0 14px"></div>
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">아직 항목이 없어요. 위에서 사진을 선택하고 <b>추출 → 추가</b>를 눌러봐!</div>
  </main>

  <!-- Tesseract.js (WASM) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const KEY = "strategy-archive-ocr-v1";

    const els = {
      title: byId('title'), tags: byId('tags'), note: byId('note'),
      imgIn: byId('imgIn'), btnOCR: byId('btnOCR'), thumbs: byId('thumbs'),
      q: byId('q'), list: byId('list'), empty: byId('empty'), stats: byId('stats'),
      btnExport: byId('btnExport'), btnImport: byId('btnImport'), fileIn: byId('fileIn'),
      lang: byId('lang'), ocrStatus: byId('ocrStatus')
    };

    let items = load();

    // ========= util =========
    function byId(id){ return document.getElementById(id); }
    function uid(){ return (crypto.randomUUID && crypto.randomUUID()) || (Date.now()+"-"+Math.random().toString(16).slice(2)); }
    function now(){ return new Date().toISOString(); }
    function load(){ try{ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; } catch{ return []; } }
    function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
    function esc(s){ return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function firstLine(t){ return (t||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)[0]; }

    // ========= preview thumbnails =========
    els.imgIn.addEventListener('change', () => {
      els.thumbs.innerHTML = '';
      const files = Array.from(els.imgIn.files || []);
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url; img.className = 'thumb';
        els.thumbs.appendChild(img);
      });
    });

    // ========= OCR and add =========
    els.btnOCR.onclick = async () => {
      const files = Array.from(els.imgIn.files || []);
      if (!files.length) return alert('이미지를 선택해줘!');
      const lang = els.lang.value || 'eng+kor';
      els.ocrStatus.textContent = '모델 로딩 중… (최초 1회는 수 MB 다운로드)';
      try{
        const worker = await Tesseract.createWorker(lang, 1, {
          logger: m => {
            if (m.status === 'recognizing text') {
              els.ocrStatus.textContent = `인식 중… ${Math.round(m.progress*100)}%`;
            } else if (m.status) {
              els.ocrStatus.textContent = (m.status || '').replace(/_/g,' ') + (m.progress? ` ${Math.round(m.progress*100)}%` : '');
            }
          }
        });

        let fullText = '';
        for (const f of files) {
          const { data: { text } } = await worker.recognize(f);
          fullText += (fullText ? '\n\n' : '') + (text||'').trim();
        }
        await worker.terminate();
        els.ocrStatus.textContent = '추출 완료!';

        const title = (els.title.value || '').trim() || firstLine(fullText) || '무제 OCR';
        const tags = (els.tags.value || '').split(',').map(s=>s.trim()).filter(Boolean);

        const item = { id: uid(), title, tags, note: (els.note.value||'').trim(), ocr: fullText, createdAt: now() };
        items = [item, ...items];
        save(items);

        // reset inputs
        els.title.value=''; els.tags.value=''; els.note.value=''; els.imgIn.value=''; els.thumbs.innerHTML='';
        render();
      }catch(err){
        console.error(err);
        alert('OCR 실패: ' + err.message);
        els.ocrStatus.textContent = '에러';
      }
    };

    // ========= render & search =========
    function render(){
      const q = (els.q.value || '').trim().toLowerCase();
      const filtered = !q ? items : items.filter(it => {
        return (it.title||'').toLowerCase().includes(q)
          || (it.tags||[]).join(' ').toLowerCase().includes(q)
          || (it.ocr||'').toLowerCase().includes(q)
          || (it.note||'').toLowerCase().includes(q);
      });
      els.stats.textContent = `전체 ${items.length}개 · 검색 ${filtered.length}개`;
      els.empty.style.display = filtered.length ? 'none' : 'block';
      els.list.innerHTML = '';

      filtered.forEach(it => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row" style="align-items:flex-start">
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;word-break:break-word">${esc(it.title)}</div>
              ${it.tags?.length ? `<div style="margin-top:6px">${it.tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join(' ')}</div>` : ''}
              ${it.note ? `<div class="muted" style="margin-top:8px;white-space:pre-wrap">${esc(it.note)}</div>` : ''}
              ${it.ocr ? `<details style="margin-top:8px"><summary>OCR 텍스트 보기</summary><pre style="white-space:pre-wrap;margin:8px 0 0">${esc(it.ocr)}</pre></details>` : ''}
              <div class="muted" style="margin-top:6px;font-size:12px">${new Date(it.createdAt).toLocaleString()}</div>
            </div>
            <div class="toolbar">
              <button data-act="edit" data-id="${it.id}">수정</button>
              <button class="danger" data-act="del" data-id="${it.id}">삭제</button>
            </div>
          </div>
        `;
        els.list.appendChild(div);
      });
    }

    els.list.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const idx = items.findIndex(i=>i.id===id); if (idx<0) return;
      if (act==='del') {
        if (confirm('삭제할까?')) { items.splice(idx,1); save(items); render(); }
      }
      if (act==='edit') {
        const t = prompt('제목 수정', items[idx].title); if (t===null) return;
        const tg = prompt('태그 수정(쉼표)', (items[idx].tags||[]).join(', '));
        items[idx].title = (t||'').trim() || items[idx].title;
        items[idx].tags = (tg||'').split(',').map(s=>s.trim()).filter(Boolean);
        save(items); render();
      }
    });

    els.q.oninput = () => render();

    // ========= export/import =========
    els.btnExport.onclick = () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='strategy-archive-ocr.json'; a.click();
      URL.revokeObjectURL(url);
    };
    els.btnImport.onclick = () => els.fileIn.click();
    els.fileIn.onchange = (ev) => {
      const f = ev.target.files[0]; if (!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const data = JSON.parse(fr.result);
          if (!Array.isArray(data)) throw new Error('JSON 배열이어야 해');
          items = data.map(x => ({
            id: x.id || uid(),
            title: x.title || '',
            tags: x.tags || [],
            note: x.note || '',
            ocr: x.ocr || '',
            createdAt: x.createdAt || now()
          }));
          save(items); render();
        } catch (e) { alert('가져오기 실패: '+e.message); }
      };
      fr.readAsText(f);
    };

    render();
  </script>
</body>
</html>
